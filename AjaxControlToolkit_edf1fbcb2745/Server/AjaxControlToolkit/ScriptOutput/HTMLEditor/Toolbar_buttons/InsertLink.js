Type.registerNamespace("Sys.Extended.UI.HTMLEditor.ToolbarButton");Sys.Extended.UI.HTMLEditor.ToolbarButton.InsertLink=function(a){Sys.Extended.UI.HTMLEditor.ToolbarButton.InsertLink.initializeBase(this,[a]);this._emptySrc=window.location.href.replace(/(http[s]*\:\/\/)[^\u0000]*/i,"$1")};Sys.Extended.UI.HTMLEditor.ToolbarButton.InsertLink.prototype={callMethod:function(){var b=this,c=b._designPanel,d=c._getSelection(),e=c._createRange(d),a=Sys.Extended.UI.HTMLEditor.getSelParent(c);if(a.nodeType==3)a=a.parentNode;while(a&&Sys.Extended.UI.HTMLEditor.isStyleTag(a.tagName)&&a.tagName.toUpperCase()!="A")a=a.parentNode;if(a&&a.tagName.toUpperCase()=="A"){b._edit=true;b._editLink(a)}else{b._edit=false;if(!b._createLink())return false}return!Sys.Extended.UI.HTMLEditor.ToolbarButton.InsertLink.callBaseMethod(b,"callMethod")?false:true},opened:function(a){this._preparePopup(a)},ok:function(e){var b=null,d="target",a=this,c=e.popupMediator.getField(d);if(c!=b)a._obj.target=c.value;var f=e.popupMediator.getField("url");if(f!=b)a._obj.href=f.value;if(/^javascript:/.test(a._obj.href)){a._obj.target=b;try{a._obj.removeAttribute(d)}catch(g){}}else{var c=e.popupMediator.getField(d);if(c!=b)a._obj.target=c.value}if(a._edit)a._edit_callback(true);else a._create_callback(true)},cancel:function(){if(this._edit)this._edit_callback(false);else this._create_callback(false)},_createLink:function(){var g=false,k="span",b=this,a=b._designPanel,l=!Sys.Extended.UI.HTMLEditor.isIE?Sys.Extended.UI.HTMLEditor.Trim(a.getSelectedHTML()):"",h=a._getSelection(),c=a._createRange(h);b._txt=null;if(!(a.isControl()&&Sys.Extended.UI.HTMLEditor.getSelParent(a).tagName&&(Sys.Extended.UI.HTMLEditor.getSelParent(a).tagName.toUpperCase()=="EMBED"||Sys.Extended.UI.HTMLEditor.getSelParent(a).tagName.toUpperCase()=="IMG"))&&!(!a.isControl()&&(Sys.Extended.UI.HTMLEditor.isIE&&c.text.length>0||!Sys.Extended.UI.HTMLEditor.isIE&&l.length>0))){a._saveContent();var j=a._doc.createElement(k);j.innerHTML="new link";j.id=Sys.Extended.UI.HTMLEditor.smartClassName;var n=true;if(Sys.Extended.UI.HTMLEditor.isIE&&a.isControl()){var d=c.item(0),o=a._doc.createElement(k);d.parentNode.insertBefore(o,d);b._txt=j.firstChild;d.parentNode.insertBefore(b._txt,d);var p=a._doc.createElement(k);d.parentNode.insertBefore(p,d);d.parentNode.removeChild(d);a.setSelectionAfterOperation([o,p],g);n=g}else{a.insertHTML(Sys.Extended.UI.HTMLEditor.getHTML(j,true));var f=a._doc.getElementById(Sys.Extended.UI.HTMLEditor.smartClassName);b._txt=f.firstChild;f.parentNode.insertBefore(f.firstChild,f);f.parentNode.removeChild(f)}if(!Sys.Extended.UI.HTMLEditor.isIE){c=a._createRange();c.setStart(b._txt,0);c.setEnd(b._txt,(""+b._txt.data+"").length);a._removeAllRanges(h);a._selectRange(h,c)}else n&&c.select();l=!Sys.Extended.UI.HTMLEditor.isIE?Sys.Extended.UI.HTMLEditor.Trim(a.getSelectedHTML()):"";h=a._getSelection();c=a._createRange(h)}if(a.isControl()&&Sys.Extended.UI.HTMLEditor.getSelParent(a).tagName.toUpperCase()=="IMG"||!a.isControl()&&(Sys.Extended.UI.HTMLEditor.isIE&&c.text.length>0||!Sys.Extended.UI.HTMLEditor.isIE&&l.length>0)){a._saveContent();b._obj={target:"default",href:b._emptySrc,title:""};for(var m=a._doc.getElementsByTagName("A"),i=[],e=0;e<m.length;e++)i.push([m[e],""+m[e].href+""]);a._execCommand("createLink",g,b._emptySrc);b._oldList=[];for(var e=0;e<i.length;e++){var q=i[e][0],r=i[e][1];q.href==r&&b._oldList.push(q)}}else{if(b._txt){a._undo(g);a.__stack.pop()}return g}return true},_editLink:function(b){var a=this._designPanel;this._obj=b;a._saveContent()},_preparePopup:function(c){var a=this;if(a._obj.target&&a._obj.target.length>0&&a._obj.target=="default")a._obj.target=a.get_relatedPopup().get_defaultTarget();var d=c.popupMediator.getField("target");if(d!=null)d.value=a._obj.target&&a._obj.target.length>0&&a._obj.target.substr(0,1)=="_"?a._obj.target.toLowerCase():"_self";var b=c.popupMediator.getField("url");if(b!=null){if(a._edit)b.value=Sys.Extended.UI.HTMLEditor.getRealAttribute(a._obj,"href");else b.value=a._obj.href;if(b.value.length==0)b.value=a._emptySrc;b.value=b.value.replace(/\&quot;/g,'"');setTimeout(function(){Sys.Extended.UI.HTMLEditor.setSelectionRange(b,0,b.value.length)},0)}},_edit_callback:function(c){var a=this,b=a._designPanel;try{if(!c)b._undo(false);else{if(a._obj.title.length==0){a._obj.title=null;a._obj.removeAttribute("title")}b.onContentChanged()}}catch(d){}return true},okCheck:function(b){var c=b.popupMediator.getField("url");if(c!=null){var a=c.value;if(a==""||a.length>=3&&a.substr(a.length-3,3)=="://"){b.alert(this.get_message("EmptyURL"));b.setTimeout(function(){try{c.focus()}catch(a){}},0);return false}return true}return false},_create_callback:function(k){var a=this,b=a._designPanel;try{if(k){for(var e=b._doc.getElementsByTagName("A"),i=0,g=0;g<e.length;g++){for(var j=true,f=e[g],h=0;h<a._oldList.length;h++)if(f==a._oldList[h]){j=false;break}if(!j)continue;i=g;if(a._obj.target)f.target=a._obj.target;f.href=a._obj.href;if(a._obj.title.length>0)f.title=a._obj.title}if(a._txt)a._txt.data=a._obj.href;if(e.length>0){var d=e[i],c=b._doc.createElement("span");c.innerHTML="&nbsp;";if(d.nextSibling!=null)d.parentNode.insertBefore(c,d.nextSibling);else d.parentNode.appendChild(c);setTimeout(function(){Sys.Extended.UI.HTMLEditor._setCursor(c,b);setTimeout(function(){d.parentNode.removeChild(c)},0)},0)}setTimeout(function(){b._editPanel.updateToolbar();b.onContentChanged()},0)}else{b._undo(false);b.__stack.pop();if(a._txt){b._undo(false);b.__stack.pop()}}b.focusEditor()}catch(l){}return true}};Sys.Extended.UI.HTMLEditor.ToolbarButton.InsertLink.registerClass("Sys.Extended.UI.HTMLEditor.ToolbarButton.InsertLink",Sys.Extended.UI.HTMLEditor.ToolbarButton.OkCancelPopupButton);