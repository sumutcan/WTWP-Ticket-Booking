// (c) 2010 CodePlex Foundation
(function(){var a=null;function b(){var e="object",j="lastFetchDataResults",f="hasChanges",h="isSaving",b=true,i="POST",c=false,d="undefined";Type._registerScript("MicrosoftAjaxDataContext.js",["MicrosoftAjaxComponentModel.js","MicrosoftAjaxCore.js"]);var g,l,k=Sys._merge;Type.registerNamespace("Sys.Net");g=Sys.Net.WebServiceOperation=function(b,c,e){if(typeof b===d)b=a;this.operation=b;this.parameters=c||a;this.httpVerb=e||a};g.prototype={operation:a,parameters:a,httpVerb:a};g.registerClass("Sys.Net.WebServiceOperation");Type.registerNamespace("Sys.Data");if(!Sys.Data.IDataProvider){g=Sys.Data.IDataProvider=function(){};g.registerInterface("Sys.Data.IDataProvider")}if(!Sys.Data.MergeOption){g=Sys.Data.MergeOption=function(){};g.prototype={appendOnly:0,overwriteChanges:1};g.registerEnum("Sys.Data.MergeOption")}g=Sys.Data.DataContext=function(){var a=this;Sys.Data.DataContext.initializeBase(a);a._dataChangedDel=Function.createDelegate(a,a._dataChanged);a._items={};a._methods={}};g.prototype={_useIdentity:c,_dirty:c,_lastResults:a,_items:a,_ignoreChange:c,_inserts:a,_edits:a,_deletes:a,_changelist:a,_hasChanges:c,_mergeOption:Sys.Data.MergeOption.overwriteChanges,_saverequest:a,_saving:c,_serviceUri:a,_saveOperation:a,_saveParameters:a,_saveHttpVerb:a,_saveTimeout:0,_methods:a,get_changes:function(){var a=this._changelist;if(!a)this._changelist=a=[];return a},get_createEntityMethod:function(){return this._methods.createEntity||a},set_createEntityMethod:function(a){this._methods.createEntity=a},get_getIdentityMethod:function(){return this._methods.getIdentity||a},set_getIdentityMethod:function(a){this._methods.getIdentity=a;this._useIdentity=!!a},get_handleSaveChangesResultsMethod:function(){return this._methods.handleSaveResults||a},set_handleSaveChangesResultsMethod:function(a){this._methods.handleSaveResults=a},get_isDeferredPropertyMethod:function(){return this._methods.isDeferredProperty||a},set_isDeferredPropertyMethod:function(a){this._methods.isDeferredProperty=a},get_getNewIdentityMethod:function(){return this._methods.getNewIdentity||a},set_getNewIdentityMethod:function(a){this._methods.getNewIdentity=a},get_getDeferredPropertyFetchOperationMethod:function(){return this._methods.getDeferredQuery||a},set_getDeferredPropertyFetchOperationMethod:function(a){this._methods.getDeferredQuery=a},get_items:function(){return this._items},get_lastFetchDataResults:function(){return this._lastResults||a},get_hasChanges:function(){return this._hasChanges},get_fetchDataMethod:function(){return this._methods.fetchData||a},set_fetchDataMethod:function(a){this._methods.fetchData=a},get_mergeOption:function(){return this._mergeOption},set_mergeOption:function(a){this._mergeOption=a},get_saveChangesMethod:function(){return this._methods.saveChanges||a},set_saveChangesMethod:function(a){this._methods.saveChanges=a},get_saveOperation:function(){return this._saveOperation||""},set_saveOperation:function(a){this._saveOperation=a},get_saveHttpVerb:function(){return this._saveHttpVerb||i},set_saveHttpVerb:function(a){this._saveHttpVerb=a},get_saveParameters:function(){return this._saveParameters},set_saveParameters:function(a){this._saveParameters=a},get_saveChangesTimeout:function(){return this._saveTimeout},set_saveChangesTimeout:function(a){this._saveTimeout=a},get_isSaving:function(){return this._saving},get_serviceUri:function(){return this._serviceUri||""},set_serviceUri:function(a){this._serviceUri=a},addLink:function(e,d,f){var c=this._toggleLink(e,d,f),g=this._setLinkField(b,e,d,f);if(!c||c.action!==Sys.Data.ChangeOperationType.remove)(g||c&&c.action===Sys.Data.ChangeOperationType.insert)&&this._registerChange(new Sys.Data.ChangeOperation(Sys.Data.ChangeOperationType.insert,a,e,d,f))},removeLink:function(e,d,f){var c=this._toggleLink(e,d,f),g=this._setLinkField(b,e,d,f,b);if(!c||c.action!==Sys.Data.ChangeOperationType.insert)(g||c&&c.action===Sys.Data.ChangeOperationType.remove)&&this._registerChange(new Sys.Data.ChangeOperation(Sys.Data.ChangeOperationType.remove,a,e,d,f))},setLink:function(d,b,e){this._toggleLink(d,b,e);this._setLinkField(c,d,b,e);this._registerChange(new Sys.Data.ChangeOperation(Sys.Data.ChangeOperationType.update,a,d,b,e))},abortSave:function(){var b=this;if(b._saverequest){b._saverequest.get_executor().abort();b._saverequest=a}if(b._saving){b._saving=c;b.raisePropertyChanged(h)}},clearChanges:function(){var b=this;b._edits=b._deletes=b._inserts=a;b._changelist&&Sys.Observer.clear(b._changelist);if(b._hasChanges){b._hasChanges=c;b.raisePropertyChanged(f)}},clearData:function(){this._clearData()},createEntity:function(a){var b=this.get_createEntityMethod();return b(this,a)},dispose:function(){var c=this;if(c._disposed)return;c._disposed=b;c.get_isSaving()&&c.abortSave();c.clearData();c._lastResults=a;c._saverequest=a;c._methods={};Sys.Data.DataContext.callBaseMethod(c,"dispose")},initialize:function(){this.updated();Sys.Data.DataContext.callBaseMethod(this,"initialize")},fetchDeferredProperty:function(n,g,m,h,j,l,o,c){var e=this,p=e.get_getDeferredPropertyFetchOperationMethod(),q=e,f=p(e,n,g,m||a,c);if(f&&f.operation){function r(d){q._setField(n,g,a,d,a,b);j&&j(d,c,g)}function s(a){l&&l(a,c,g)}if(typeof c===d)c=a;if(typeof h===d||h===a)h=e.get_mergeOption();return e.fetchData(f.operation,k(a,f.parameters,m),h,f.httpVerb||i,r,s,o||0,c)}},getNewIdentity:function(d,c){var b=this.get_getNewIdentityMethod();return b?b(this,d,c)||a:a},insertEntity:function(d,e){var b=this,c=a;if(b._useIdentity){c=b.getIdentity(d);if(c===a)c=b.getNewIdentity(d,e||a);if(!c)throw Error.invalidOperation(Sys.Data.DataRes.requiredIdentity);if(b._items[c])throw Error.invalidOperation(String.format(Sys.Data.DataRes.entityAlreadyExists,c));b._storeEntity(c,d)}else b._captureEntity(d);b._inserts=b._pushChange(b._inserts,d,c);b._registerChange(new Sys.Data.ChangeOperation(Sys.Data.ChangeOperationType.insert,d))},removeEntity:function(e){var c=this;if(c._ignoreChange)return;var g=c.getIdentity(e);if(g!==a){e=c._items[g];if(typeof e===d)return;delete c._items[g]}c._releaseEntity(e);var k=c,h=c.get_changes(),j=c._hasChanges;function i(){for(var a=0,b=h.length;a<b;a++)if(h[a].item===e){Sys.Observer.removeAt(h,a);k._hasChanges=!!h.length;return}}if(c._peekChange(c._inserts,e,g,b)){c._removeChanges(e,"*");i()}else{c._deletes=c._pushChange(c._deletes,e,g);c._peekChange(c._edits,e,g,b)&&i();c._removeChanges(e,"*",b);Sys.Observer.add(h,new Sys.Data.ChangeOperation(Sys.Data.ChangeOperationType.remove,e));c._hasChanges=b}c._hasChanges!==j&&c._raiseChanged(f)},fetchData:function(g,m,f,h,k,l,n,b){var e=this,j=e;if(typeof f===d||f===a)f=e.get_mergeOption();function p(c){if(j._disposed)return;var a=j.trackData(c,f);if(k){if(c instanceof Array&&a===c)a=Array.clone(a);k(a,b,g)}}function q(a){if(j._disposed)return;l&&l(a,b,g)}if(typeof b===d)b=a;var o=e.get_fetchDataMethod(),r=e.get_serviceUri();return o?o(e,r,g,m||a,h||i,p,q,n||0,b):Sys.Net.WebServiceProxy.invoke(r,g,h?h==="GET":c,m||a,p,q,b,n||0)},_clearData:function(c){var b=this;if(b._useIdentity)for(var d in b._items){var f=b._items[d];b._releaseEntity(f)}else b._lastResults&&b._release(b._lastResults);b._items={};var e=b._lastResults;b._lastResults=c||a;b.clearChanges();c&&b._capture(c);e!==a&&b._raiseChanged(j)},_fixAfterSave:function(f,b,c){var a=this;if(a._useIdentity){var e=a.getIdentity(b),d=a.getIdentity(c);a._combine(b,c);if(e!==d){delete a._items[e];a._items[d]=b}}else{a._combine(b,c);f.action===Sys.NotifyCollectionChangedAction.add&&a._captureEntity(b)}},trackData:function(b,e){var c=this;if(c._useIdentity){if(typeof e===d||e===a)e=c.get_mergeOption();var f;if(b instanceof Array)b=c._storeEntities(b,e);else if(typeof b!==d&&b!==a){f=c._storeEntities([b],e);if(f.length===0)b=a}var g=c._lastResults;c._lastResults=b;g!==a&&c._raiseChanged(j)}else c._clearData(b);return b},_processResults:function(f,h,a){if(a&&a.length===h.length){f._ignoreChange=b;try{for(var d=0,k=a.length;d<k;d++){var g=a[d],i=h[d],j=i.item;g&&typeof g===e&&f._fixAfterSave(i,j,g)}}finally{f._ignoreChange=c}}},_peekChange:function(d,f,e,g){if(!d)return c;if(e!==a){var h="id$"+e,i=d[h];if(i){if(g)d[h]=a;return b}}else return g?Array.remove(d,f):Array.contains(d,f)},_pushChange:function(c,e,d){if(!c)c=[];if(d===a)c.push(e);else c["id$"+d]=b;return c},_registerChange:function(c){var a=this;Sys.Observer.add(a.get_changes(),c);if(!a._hasChanges){a._hasChanges=b;a.raisePropertyChanged(f)}},saveChanges:function(k,l,j){var d=this,f=c,p=d.get_serviceUri(),m=d.get_saveOperation(),e=d,g;function i(d){if(e._disposed)return;if(!f){f=b;window.setTimeout(function(){i(d)},0)}else{e.clearChanges();var l=e.get_handleSaveChangesResultsMethod();(l||e._processResults)(e,g,d);e._saverequest=a;e._saving=c;e._raiseChanged(h);k&&k(d,j,m)}}function n(d){if(e._disposed)return;if(!f){f=b;window.setTimeout(function(){n(d)},0)}else{e._saverequest=a;e._saving=c;e._raiseChanged(h);l&&l(d,j,m)}}if(!d._hasChanges){i(a);return a}g=Array.clone(d.get_changes());if(g.length===0){i(a);return a}d.get_isSaving()&&d.abortSave();d._saving=b;d._raiseChanged(h);var o=d._filterLinks(g);d._saverequest=(d.get_saveChangesMethod()||d._saveInternal)(d,o,i,n,j);f=b;return d._saverequest},_isDeleted:function(f){var d,g,a,e=this.get_changes(),h=this.getIdentity(f);for(d=0,g=e.length;d<g;d++){a=e[d];if(a.action===Sys.Data.ChangeOperationType.remove&&a.item&&(a.item===f||this.getIdentity(a.item)===h))return b}return c},_removeChanges:function(j,i,m){var h=this,b,k,d,a,g=h.get_changes(),l=i==="*";for(b=0,k=g.length;b<k;b++){a=g[b];if(i&&(!m||a.action===Sys.Data.ChangeOperationType.insert)&&(a.linkSource===j||l&&a.linkTarget===j)&&(l||a.linkSourceField===i)||!i&&a.item&&typeof a.item===e&&(a.item===j||h.getIdentity(a.item)===h.getIdentity(j))){if(!d)d=[];d.push(a)}}if(d){Sys.Observer.beginUpdate(g);for(b=0,k=d.length;b<k;b++)Sys.Observer.remove(g,d[b]);Sys.Observer.endUpdate(g);if(g.length===0){h._hasChanges=c;h.raisePropertyChanged(f)}}},_setLinkField:function(j,e,g,i,h){var f=this;if(j){var d=e[g];if(d===a||f._getValueType(e,g,d)!==2){if(h)return c;e[g]=d=[]}f._ignoreChange=b;try{if(Array.contains(d,i))if(h){Sys.Observer.remove(d,i);return b}else return c;else if(h)return c;else{Sys.Observer.add(d,i);return b}}finally{f._ignoreChange=c}}else{f._ignoreChange=b;try{if(h)Sys.Observer.setValue(e,g,a);else Sys.Observer.setValue(e,g,i);return b}finally{f._ignoreChange=c}}},_toggleLink:function(h,j,i){var c=this;for(var b,d=c.get_changes(),e=0,k=d.length;e<k;e++){b=d[e];if(b.linkSourceField===j&&b.linkSource===h&&(b.linkTarget===i||b.action===Sys.Data.ChangeOperationType.update)){Sys.Observer.remove(d,b);var g=c._hasChanges;c._hasChanges=!!d.length;g!==c._hasChanges&&c.raisePropertyChanged(f);return b}}return a},updated:function(){if(this._dirty){this._dirty=c;this.raisePropertyChanged("")}},_capture:function(b){if(b instanceof Array)for(var c=0,d=b.length;c<d;c++)this._captureEntity(b[c]);else b!==a&&this._captureEntity(b)},_captureEntity:function(a){this._isCaptureable(a)&&Sys.Observer.addPropertyChanged(a,this._dataChangedDel)},_dataChanged:function(c){var a=this;if(a._ignoreChange)return;var g=a.get_changes(),d=a.getIdentity(c);if(!a._peekChange(a._inserts,c,d)){var e=a._peekChange(a._edits,c,d);if(!e){Sys.Observer.add(g,new Sys.Data.ChangeOperation(Sys.Data.ChangeOperationType.update,c));a._edits=a._pushChange(a._edits,c,d);if(!a._hasChanges){a._hasChanges=b;a.raisePropertyChanged(f)}}}},_isActive:function(){return this.get_isInitialized()&&!this.get_isUpdating()},_isCaptureable:function(b){if(b===a)return c;var d=typeof b;return d===e||d==="unknown"},_raiseChanged:function(a){if(this._isActive()){this.raisePropertyChanged(a);return b}else{this._dirty=b;return c}},_release:function(b){if(b instanceof Array)for(var c=0,d=b.length;c<d;c++)this._releaseEntity(b[c]);else b!==a&&this._releaseEntity(b)},_releaseEntity:function(a){this._isCaptureable(a)&&Sys.Observer.removePropertyChanged(a,this._dataChangedDel)},_saveInternal:function(b,j,i,e,f){var h=b.get_serviceUri(),d=b.get_saveOperation()||"",g=a;if(!h)e(new Sys.Net.WebServiceError(c,String.format(Sys.Res.webServiceFailedNoMsg,d)),f,d);else g=Sys.Net.WebServiceProxy.invoke(h,d,b.get_saveHttpVerb()==="GET",k(a,b.get_saveParameters(),{changeSet:j}),i,e,f,b.get_saveChangesTimeout()||0);return g},_filterLinks:function(g){var d=this;if(!d._useIdentity)return g;for(var i=g.length,h=new Array(i),f=0;f<i;f++){var a=g[f],e=a.item,b=a.linkSource,c=a.linkTarget;if(e)e=d._getEntityOnly(e);if(b)b=d._getEntityOnly(b);if(c)c=d._getEntityOnly(c);h[f]=new Sys.Data.ChangeOperation(a.action,e,b,a.linkSourceField,c)}return h},_getEntityOnly:function(d){var c={};this._combine(c,d,a,b);return c},getIdentity:function(b){if(b===a)return a;var c=this.get_getIdentityMethod();return c?c(this,b)||a:a},isDeferredProperty:function(d,b){var a=this.get_isDeferredPropertyMethod();return a?a(this,d,b)||c:c},_getValueType:function(f,g,b){var c=typeof b;return c===d?0:b===a||c!==e?2:this.isDeferredProperty(f,g)?1:2},_setField:function(f,g,m,a,n,o){var d=this,i=b,l=f instanceof Array,j=n===Sys.Data.MergeOption.appendOnly;if(!l){var h=f[g],k=d._getValueType(f,g,h);if(j){if(k===2&&(!h||!a||typeof h!==e||h instanceof Array||typeof a!==e||a instanceof Array||d.getIdentity(h)!==d.getIdentity(a)))i=c}else if(k===2&&a&&m&&d._getValueType(m,g,a)===1)i=c}if(i){if(l)f[g]=a;else{d._ignoreChange=b;try{Sys.Observer.setValue(f,g,a)}finally{d._ignoreChange=c}}o&&!j&&d._removeChanges(f,g)}return i},_combine:function(g,i,h,m){var f=this,n=c;for(var j in i){var d=i[j],o=typeof d;if(o==="function")continue;if(f._useIdentity&&d instanceof Array){if(!m){d=f._storeEntities(d,h);g&&f._setField(g,j,i,d,h,b)}}else{var l=a;if(d&&o===e)l=f.getIdentity(d);if(l!==a)!m&&f._storeEntity(l,d,g,j,i,h);else if(g){var k=g[j];if(k&&typeof k===e&&f.getIdentity(k))continue;if(f._setField(g,j,i,d,h)&&!n&&(typeof h!=="number"||h===Sys.Data.MergeOption.overwriteChanges)){n=b;f._removeChanges(g)}}}}},_storeEntity:function(j,e,h,i,l,g){var f=this,k=b,a=f._items[j];if(typeof a!==d)if(a===e)k=c;else f._combine(a,e,g);else{f._items[j]=a=e;f._captureEntity(e);f._combine(e,e,g)}h&&h[i]!==a&&f._setField(h,i,l,a,g,b);return k},_storeEntities:function(f,j){var g=this,b,h,i,d,k=j===Sys.Data.MergeOption.appendOnly;for(b=0,h=f.length;b<h;b++){var c=f[b],m=c&&typeof c===e;if(m){if(k)if(g._isDeleted(c)){d=d||[];d.push(c);continue}var l=g.getIdentity(c);if(l!==a)g._storeEntity(l,c,f,b,a,j)&&!k&&g._removeChanges(c)}}if(d){i=Array.clone(f);for(b=0,h=d.length;b<h;b++)Array.remove(i,d[b])}return i||f}};g.registerClass("Sys.Data.DataContext",Sys.Component,Sys.Data.IDataProvider);Sys.registerComponent(g);g=Sys.Data.ChangeOperationType=function(){};g.prototype={insert:0,update:1,remove:2};g.registerEnum("Sys.Data.ChangeOperationType");g=Sys.Data.ChangeOperation=function(e,f,c,b,d){var a=this;a.action=e;a.item=f;a.linkSourceField=b;a.linkSource=c;a.linkTarget=d};g.prototype={action:a,item:a,linkSource:a,linkSourceField:a,linkTarget:a};g.registerClass("Sys.Data.ChangeOperation")}if(window.Sys&&Sys.loader)Sys.loader.registerScript("DataContext",a,b);else b()})();Type.registerNamespace("Sys.Data");Sys.Data.DataRes={entityAlreadyExists:"Entity '{0}' already exists and cannot be added again.",requiredIdentity:"The entity must have an identity or a new identity must be creatable with the set getNewIdentityMethod."};